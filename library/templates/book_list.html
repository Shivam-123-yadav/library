{% extends "base.html" %}
{% block title %}Books{% endblock %}
{% include "partials/recent_section.html" %}

{% block content %}

<style>
    body {
        background: #f1f3f6; /* Flipkart bg */
        height: 500px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* Section Title */
    h2 {
        color: #212121;
        font-weight: bold;
    }


    #booksContainer {
    width: 100%;
    max-width: 1800px; /* optional */
    margin: auto; /* keeps it centered */
}


    /* Card styling */
    .book-card {
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    background: #fff;
    transition: 0.2s ease;
    width: 100%;   /* column ke full width le lega */
}

    }
    .book-card:hover {
        box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        transform: translateY(-3px);
    }

    /* Image */
    .book-img {
        height: 220px;
        object-fit: contain;
        padding: 15px;
    }

    /* Price */
    .book-price {
        font-size: 18px;
        font-weight: 600;
        color: #388e3c; /* Flipkart green */
    }

    /* Buy Button */
    .btn-buy {
        background-color: #2874f0; /* Flipkart blue */
        color: #fff;
        font-weight: 600;
        border: none;
        transition: 0.3s;
    }
    .btn-buy:hover {
        background-color: #0b58d1;
        color: #fff;
    }

    /* Like */
    .btn-like {
        border: 1px solid #ccc;
        background: #fff;
        color: #555;
    }
    .btn-like:hover {
        background: #f8f8f8;
    }

    /* Search */
    #searchInput {
        border-radius: 30px;
        border: 1px solid #ddd;
    }

    /* Modal Image */
    .modal-body img {
        width: 100%; /* Full width */
        height: auto; /* Maintain aspect ratio */
        object-fit: contain; /* Ensure full coverage */
    }



 

/* Hover effect */
.dd {position:relative;
     transition: 1s all;
}
.dd:hover {
  transform: translateY(-8px) scale(1.02);
  {% comment %} box-shadow: 0px 0px 10px 3px rgb(21 108 236 / 34%); {% endcomment %}
}

</style>

<div class="d-flex justify-content-between align-items-center mb-4" id="books-section">
    <h2>üìö Books Store</h2>
    {% if user.is_superuser %}
    <a class="btn btn-buy px-4 py-2 rounded-pill dd" href="{% url 'book_create' %}">+ Add Book</a>
    {% endif %}
</div>


<form class="row g-2 align-items-end mb-3" method="get">
  <div class="col-md-4">
    <label class="form-label">Filter by Author</label>
    <select name="author" class="form-select">
      <option value="">All</option>
      {% for a in authors %}
       <option value="{{ a.id }}" {% if request.GET.author == a.id|stringformat:'s' %}selected{% endif %}>{{ a.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">Sort</label>
    <select name="sort" class="form-select">
      <option value="-published_date" {% if request.GET.sort|default:'-published_date' == "-published_date" %}selected{% endif %}>Newest</option>
      <option value="title" {% if request.GET.sort == "title" %}selected{% endif %}>Title (A‚ÜíZ)</option>
      <option value="author__name" {% if request.GET.sort == "author__name" %}selected{% endif %}>Author (A‚ÜíZ)</option>
      <option value="price" {% if request.GET.sort == "price" %}selected{% endif %}>Price (Low‚ÜíHigh)</option>
      <option value="-price" {% if request.GET.sort == "-price" %}selected{% endif %}>Price (High‚ÜíLow)</option>
    </select>
  </div>
  <div class="col-md-4">
    <button class="btn btn-dark w-100 dd">Apply</button>
  </div>
</form>

{% comment %} <!-- üîç Search Bar -->
<div class="input-group mb-5" style="max-width: 450px;">
  <input type="text" id="searchInput" class="form-control" placeholder="Search books...">
  <button class="btn btn-outline-secondary">üîç</button>
</div> {% endcomment %}

<!-- Books List -->

<div id="booksContainer" class="row row-cols-2 row-cols-md-4 g-4 w-100 mx-0 ">
    {% for book in books %}
    <div class="col dd" >
        <div class="card book-card h-100">
            {% if book.image %}
            <a href="#" data-bs-toggle="modal" data-bs-target="#imgModal{{ book.id }}">
                <img src="{{ book.image.url }}" class="card-img-top book-img" alt="{{ book.title }}">
            </a>
            {% else %}
            <div class="bg-light d-flex align-items-center justify-content-center book-img">
                No Image
            </div>
            {% endif %}

            <div class="card-body p-2 d-flex flex-column">
                <h6 class="card-title text-dark fw-bold">{{ book.title|truncatechars:30 }}</h6>
                <p class="text-muted small mb-1">By {{ book.author.name }}</p>
                <p class="book-price mb-1">‚Çπ{{ book.price }}</p>
                <p class="text-muted small">{{ book.description|truncatewords:12 }}</p>

                <form method="post" action="{% url 'like_book' book.id %}" class="mb-2">
                    {% csrf_token %}
                    {% if user in book.likes.all %}
                    <button class="btn btn-sm btn-danger w-100">‚ù§Ô∏è Unlike</button>
                    {% else %}
                    <button class="btn btn-sm btn-like w-100">üëç Like</button>
                    {% endif %}
                </form>
                <small class="text-muted">{{ book.total_likes }} Likes</small>

                <a href="{% url 'buy_now' book.id %}" class="btn btn-buy w-100 mt-2">üõí Buy Now</a>

                {% if user.is_superuser %}
                <div class="mt-2 d-flex justify-content-between">
                    <a class="btn btn-sm btn-warning" href="{% url 'book_update' book.pk %}">Edit</a>
                    <a class="btn btn-sm btn-danger" href="{% url 'book_delete' book.pk %}" onclick="return confirm('Delete this book?')">Delete</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    

    <!-- Modal -->
    {% if book.image %}
    <div class="modal fade" id="imgModal{{ book.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded">
          <div class="modal-header">
            <h5 class="modal-title">{{ book.title }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <img src="{{ book.image.url }}" class="img-fluid rounded mb-3" alt="{{ book.title }}">
            <p><strong>Author:</strong> {{ book.author.name }}</p>
            <p><strong>Published:</strong> {{ book.published_date }}</p>
            <p><strong>Price:</strong> ‚Çπ{{ book.price }}</p>
            <p class="text-secondary">{{ book.description }}</p>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    {% empty %}
    <div class="col">
        <div class="alert alert-secondary text-center">No books yet.</div>
    </div>
    {% endfor %}
</div>

<!-- JS for Live API Search -->
<script>
{% comment %} const searchInput = document.getElementById("searchInput");
const booksContainer = document.getElementById("booksContainer");

let debounceTimer;
searchInput.addEventListener("input", function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        const query = searchInput.value.trim();
        fetch(`/books/search_api/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            booksContainer.innerHTML = "";
            if (data.results.length === 0) {
                booksContainer.innerHTML = `<div class="col"><div class="alert alert-warning text-center">No results found</div></div>`;
            } else {
                data.results.forEach(book => {
                    booksContainer.innerHTML += `
                    <div class="col">
                        <div class="card book-card h-100">
                            ${book.image ? `<img src="${book.image}" class="card-img-top book-img">` : `<div class="bg-light d-flex align-items-center justify-content-center book-img">No Image</div>`}
                            <div class="card-body p-2">
                                <h6 class="fw-bold">${book.title}</h6>
                                <p class="text-muted small mb-1">By ${book.author}</p>
                                <p class="book-price">‚Çπ${book.price}</p>
                                <p class="text-muted small">${book.description.substring(0,80)}...</p>
                            </div>
                        </div>
                    </div>`;
                });
            }
        });
    }, 300);
}); {% endcomment %}
</script>

{% endblock %}
